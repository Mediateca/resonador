var config={apiKey:"AIzaSyDxRiTUgTD_KKfaeeY0HfUU4iZVcndq3mg",authDomain:"resonador-82846.firebaseapp.com",databaseURL:"https://resonador-82846.firebaseio.com",storageBucket:"resonador-82846.appspot.com",messagingSenderId:"237677222662"};firebase.initializeApp(config);var app=angular.module("app",["ngAnimate","ngAria","ngMaterial","ngMessages","ngRoute","ngSanitize","firebase","ngclipboard","material.components.expansionPanels","ngFileUpload"]),rutaAvatarGenerica="assets/img/avatar_generico.png";app.controller("main",[function(){console.log("main")}]),app.controller("contenido",["$firebaseAuth","$location",function($firebaseAuth,$location){console.log("contenido");var vista,ruta=$location.path(),rutaVista="views";switch(ruta){case"/":vista=rutaVista+ruta+"inicio.html";break;default:vista=rutaVista+ruta+".html"}var raiz=this,auth=$firebaseAuth();auth.$onAuthStateChanged(function(firebaseUser){firebaseUser?(raiz.rutaHeader="assets/html/header.html",raiz.rutaSidenav="assets/html/sidenav.html",raiz.rutaCuerpo=vista):(raiz.rutaHeader=null,raiz.rutaSidenav=null,"/perdiClave"!=ruta&&"/registro"!=ruta?raiz.rutaCuerpo=rutaVista+"/login.html":raiz.rutaCuerpo=rutaVista+ruta+".html")})}]),app.controller("header",["$firebaseAuth","$firebaseObject","$firebaseStorage","$firebaseArray","$rootScope",function($firebaseAuth,$firebaseObject,$firebaseStorage,$firebaseArray,$rootScope){console.log("header");var raiz=this;raiz.auth=$firebaseAuth();var usuarioAutenticado=raiz.auth.$getAuth(),listaUsuarios=$firebaseArray(firebase.database().ref("usuarios"));listaUsuarios.$loaded().then(function(ref){angular.forEach(listaUsuarios,function(valor,llave){valor.email==usuarioAutenticado.email&&(raiz.usuario=$firebaseObject(firebase.database().ref("usuarios/"+valor.$id)),raiz.usuario.$loaded().then(function(ref){if(raiz.usuario.avatar){var rutaAvatar=firebase.storage().ref("usuarios/avatar/"+raiz.usuario.$id+"."+raiz.usuario.avatar),ruta=$firebaseStorage(rutaAvatar);ruta.$getDownloadURL().then(function(url){raiz.rutaAvatar=url},function(error){raiz.rutaAvatar=rutaAvatarGenerica})}else raiz.rutaAvatar=rutaAvatarGenerica}))})}),raiz.abreMenu=function($mdOpenMenu,ev){$mdOpenMenu(ev)},$rootScope.$on("userUpdate",function(event,data){raiz.usuario=data[0],raiz.rutaAvatar=data[1]})}]),app.controller("sidenav",[function(){console.log("sidenav")}]),app.controller("login",["$firebaseAuth",function($firebaseAuth){console.log("login");var raiz=this,auth=$firebaseAuth();raiz.autenticar=function(){auth.$signInWithEmailAndPassword(raiz.usuario,raiz.clave).then(function(firebaseUser){console.log("Logueado como",firebaseUser.email)}).catch(function(error){console.log("Error",error)})}}]),app.controller("registro",["$firebaseObject","$firebaseAuth","$mdDialog","$location",function($firebaseObject,$firebaseAuth,$mdDialog,$location){console.log("registro");var usuario,auth=$firebaseAuth(),raiz=this;raiz.codigoValidado=!1,raiz.codigoInvalido=!1,raiz.validarCodigo=function(codigo){usuario=$firebaseObject(firebase.database().ref("usuarios/"+codigo)),codigo&&usuario.$loaded().then(function(data){null===usuario.$value||usuario.email?raiz.codigoInvalido=!0:(raiz.codigoValidado=!0,raiz.codigoInvalido=!1)},function(error){console.log("Error",error)})},raiz.enterCodigo=function(tecla,codigo){"Enter"==tecla.key&&raiz.validarCodigo(codigo)},raiz.registrar=function(){auth.$createUserWithEmailAndPassword(raiz.email,raiz.clave).then(function(firebaseUser){usuario.nombres=raiz.nombres,usuario.apellidos=raiz.apellidos,usuario.email=raiz.email,usuario.estado=!0,usuario.avatar=!1,usuario.$save().then(function(){$mdDialog.show($mdDialog.alert().clickOutsideToClose(!0).title("Registro exitoso").textContent("Ha sido registrado correctamente. Ahora será re-dirigido a la página principal.").ariaLabel("Registro existoso").ok("Aceptar")).then(function(){auth.$signInWithEmailAndPassword(raiz.email,raiz.clave).then(function(firebaseUser){console.log("Logueado como",firebaseUser.email),$location.path("/")}).catch(function(error){console.log("Error",error)})})},function(error){console.log("Error",error)})}).catch(function(error){console.error("Error: ",error)})}}]),app.controller("editarPerfil",["$firebaseAuth","$firebaseObject","$firebaseStorage","$firebaseArray","$rootScope","$mdToast","$timeout",function($firebaseAuth,$firebaseObject,$firebaseStorage,$firebaseArray,$rootScope,$mdToast,$timeout){console.log("editarPerfil");var raiz=this;raiz.cargandoImagen=!1,raiz.auth=$firebaseAuth(),raiz.claveActualValida=!1,raiz.verificandoClave=!1,raiz.errorAutenticacion=!1,raiz.cambiandoClave=!1;var avatarStorage,usuarioAutenticado=raiz.auth.$getAuth(),listaUsuarios=$firebaseArray(firebase.database().ref("usuarios"));listaUsuarios.$loaded().then(function(ref){angular.forEach(listaUsuarios,function(valor,llave){valor.email==usuarioAutenticado.email&&(raiz.usuario=$firebaseObject(firebase.database().ref("usuarios/"+valor.$id)),raiz.usuario.$loaded().then(function(ref){if(raiz.usuario.avatar){var rutaAvatar=firebase.storage().ref("usuarios/avatar/"+raiz.usuario.$id+"."+raiz.usuario.avatar);avatarStorage=$firebaseStorage(rutaAvatar),avatarStorage.$getDownloadURL().then(function(url){raiz.rutaAvatar=url},function(error){raiz.rutaAvatar=rutaAvatarGenerica})}else raiz.rutaAvatar=rutaAvatarGenerica}))})}),raiz.cambiarAvatar=function(avatar){if(raiz.cargandoImagen=!0,avatar){var extension;switch(avatar.type){case"image/jpeg":extension="jpg";break;case"image/png":extension="png";break;case"image/gif":extension="gif";break;default:extension="jpg"}var cargaAvatar;avatarStorage.$delete().then(function(){raiz.usuario.avatar=extension,avatarStorage=$firebaseStorage(firebase.storage().ref("usuarios/avatar/"+raiz.usuario.$id+"."+extension)),cargaAvatar=avatarStorage.$put(avatar,{contentType:avatar.type,usuario:avatar.email}),cargaAvatar.$progress(function(snapshot){raiz.porcentajeCarga=snapshot.bytesTransferred/snapshot.totalBytes*100}),cargaAvatar.$complete(function(snapshot){raiz.rutaAvatar=snapshot.downloadURL,raiz.cargandoImagen=!1,raiz.guardaDatos(0)})})}},raiz.guardaDatos=function(delay){$timeout(function(){usuarioAutenticado.updateProfile({displayName:raiz.usuario.nombres+" "+raiz.usuario.apellidos,photoURL:raiz.rutaAvatar}).then(function(){console.log("Datos auth actualizados")},function(error){console.log("Error",error)}),raiz.usuario.$save(),$rootScope.$emit("userUpdate",[raiz.usuario,raiz.rutaAvatar]),$mdToast.show($mdToast.simple().textContent("¡Datos actualizados!").hideDelay(3e3))},delay)},raiz.validaClave=function(){raiz.verificandoClave=!0;var credencial=firebase.auth.EmailAuthProvider.credential(usuarioAutenticado.email,raiz.claveActual);usuarioAutenticado.reauthenticate(credencial).then(function(){raiz.claveActualValida=!0,raiz.errorAutenticacion=!1,$timeout(function(){raiz.verificandoClave=!1},1e3)},function(error){console.log("Error re-autenticando",error),raiz.claveActualValida=!1,$timeout(function(){raiz.verificandoClave=!1,raiz.errorAutenticacion=!0},1e3)})},raiz.guardaClave=function(panel){raiz.cambiandoClave=!0,raiz.auth.$updatePassword(raiz.claveNueva).then(function(){$timeout(function(){raiz.cambiandoClave=!1,panel.collapse(),raiz.claveVerif="",raiz.claveNueva="",raiz.claveActual="",$mdToast.show($mdToast.simple().textContent("¡Contraseña actualizada!").hideDelay(3e3))},1e3)}).catch(function(error){raiz.cambiandoClave=!1,$mdToast.show($mdToast.simple().textContent("Error:"+error+" Intente de nuevo.").hideDelay(5e3))})}}]);